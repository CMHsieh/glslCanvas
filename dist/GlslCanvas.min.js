!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.GlslCanvas=t()}(this,function(){"use strict";function e(e,t,i){for(var r=0,n=e.length;r<n;r++)L.call(e,r)&&t.call(i,e[r],r,e)}function t(e,t,i){for(var r=0,n=e.length;r<n;r++)t.call(i,e.charAt(r),r,e)}function i(e,t,i){for(var r in e)L.call(e,r)&&t.call(i,e[r],r,e)}function r(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}function n(e,t,i){var r=e;return A(t)?(i=t,"string"==typeof e&&(r={uri:e})):r=P(t,{uri:e}),r.callback=i,r}function s(e,t,i){return t=n(e,t,i),a(t)}function a(e){function t(){var e=void 0;if(e=l.response?l.response:l.responseText||o(l),p)try{e=JSON.parse(e)}catch(e){}return e}function i(e){return clearTimeout(d),e instanceof Error||(e=new Error(""+(e||"Unknown XMLHttpRequest Error"))),e.statusCode=0,h(e,R)}function n(){if(!f){var i;clearTimeout(d),i=e.useXDR&&void 0===l.status?200:1223===l.status?204:l.status;var r=R,n=null;return 0!==i?(r={body:t(),statusCode:i,method:c,headers:{},url:g,rawRequest:l},l.getAllResponseHeaders&&(r.headers=S(l.getAllResponseHeaders()))):n=new Error("Internal XMLHttpRequest Error"),h(n,r,r.body)}}if(void 0===e.callback)throw new Error("callback argument missing");var a=!1,h=function(t,i,r){a||(a=!0,e.callback(t,i,r))},l=e.xhr||null;l||(l=e.cors||e.useXDR?new s.XDomainRequest:new s.XMLHttpRequest);var u,f,d,g=l.url=e.uri||e.url,c=l.method=e.method||"GET",m=e.body||e.data,E=l.headers=e.headers||{},T=!!e.sync,p=!1,R={body:void 0,headers:{},statusCode:0,method:c,url:g,rawRequest:l};if("json"in e&&!1!==e.json&&(p=!0,E.accept||E.Accept||(E.Accept="application/json"),"GET"!==c&&"HEAD"!==c&&(E["content-type"]||E["Content-Type"]||(E["Content-Type"]="application/json"),m=JSON.stringify(!0===e.json?m:e.json))),l.onreadystatechange=function(){4===l.readyState&&setTimeout(n,0)},l.onload=n,l.onerror=i,l.onprogress=function(){},l.onabort=function(){f=!0},l.ontimeout=i,l.open(c,g,!T,e.username,e.password),T||(l.withCredentials=!!e.withCredentials),!T&&e.timeout>0&&(d=setTimeout(function(){if(!f){f=!0,l.abort("timeout");var e=new Error("XMLHttpRequest timeout");e.code="ETIMEDOUT",i(e)}},e.timeout)),l.setRequestHeader)for(u in E)E.hasOwnProperty(u)&&l.setRequestHeader(u,E[u]);else if(e.headers&&!r(e.headers))throw new Error("Headers cannot be set on an XDomainRequest object");return"responseType"in e&&(l.responseType=e.responseType),"beforeSend"in e&&"function"==typeof e.beforeSend&&e.beforeSend(l),l.send(m||null),l}function o(e){if("document"===e.responseType)return e.responseXML;var t=e.responseXML&&"parsererror"===e.responseXML.documentElement.nodeName;return""!==e.responseType||t?null:e.responseXML}function h(e){return e.getBoundingClientRect().top+e.height>0&&e.getBoundingClientRect().top<(window.innerHeight||document.documentElement.clientHeight)}function l(e){return 0==(e&e-1)}function u(){return/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}function f(e,t){return!(!e||!t)&&e.toString()!==t.toString()}function d(e){var t=new Set;return Object.assign(e,{on(e,i){let r={};r[e]=i,t.add(r)},off(e,i){if(i){let r={};r[e]=i,t.delete(r)}else for(let i of t)for(let r of Object.keys(i))if(r===e)return void t.delete(i)},listSubscriptions(){for(let e of t)console.log(e)},subscribe(e){t.add(e)},unsubscribe(e){t.delete(e)},unsubscribeAll(){t.clear()},trigger(e,...i){for(var r of t)"function"==typeof r[e]&&r[e](...i)}})}function g(e){return'\n<table style="background-color: #8CE; width: 100%; height: 100%;"><tr>\n<td align="center">\n<div style="display: table-cell; vertical-align: middle;">\n<div style="">'+e+"</div>\n</div>\n</td></tr></table>\n"}function c(e,t,i){function r(t){let i=e.parentNode;i&&(i.innerHTML=g(t))}function n(e,t){"function"==typeof i?i(e):r(t)}if(!window.WebGLRenderingContext)return n(O,I),null;let s=m(e,t);return s?s.getExtension("OES_standard_derivatives"):n(B,N),s}function m(e,t){let i=["webgl","experimental-webgl"],r=null;for(var n=0;n<i.length;++n)try{r=e.getContext(i[n],t)}catch(e){if(r)break}return r}function E(e,t,i,r){let n=e.gl,s=n.createShader(i);return n.shaderSource(s,t),n.compileShader(s),n.getShaderParameter(s,n.COMPILE_STATUS)?s:(C=n.getShaderInfoLog(s),console.error("*** Error compiling shader "+s+":"+C),e.trigger("error",{shader:s,source:t,type:i,error:C,offset:r||0}),n.deleteShader(s),null)}function T(e,t,i,r){let n=e.gl,s=n.createProgram();for(let e=0;e<t.length;++e)n.attachShader(s,t[e]);if(i)for(let e=0;e<i.length;++e)n.bindAttribLocation(s,r?r[e]:e,i[e]);return n.linkProgram(s),n.getProgramParameter(s,n.LINK_STATUS)?s:(C=n.getProgramInfoLog(s),console.log("Error in program linking:"+C),n.deleteProgram(s),null)}function p(e,t=null){let i=[];for(let r in e){let n,s=e[r];if(t&&(r=t+"."+r),"number"==typeof s)i.push({type:"float",method:"1f",name:r,value:s});else if(Array.isArray(s)){if("number"==typeof s[0])1===s.length?i.push({type:"float",method:"1f",name:r,value:s}):s.length>=2&&s.length<=4?i.push({type:"vec"+s.length,method:s.length+"fv",name:r,value:s}):s.length>4&&i.push({type:"float[]",method:"1fv",name:r+"[0]",value:s});else if("string"==typeof s[0])i.push({type:"sampler2D",method:"1i",name:r,value:s});else if(Array.isArray(s[0])&&"number"==typeof s[0][0]){if(s[0].length>=2&&s[0].length<=4)for(n=0;n<s.length;n++)i.push({type:"vec"+s[0].length,method:s[n].length+"fv",name:r+"["+n+"]",value:s[n]})}else if("object"==typeof s[0])for(n=0;n<s.length;n++)i.push(...p(s[n],r+"["+n+"]"))}else"boolean"==typeof s?i.push({type:"bool",method:"1i",name:r,value:s}):"string"==typeof s?i.push({type:"sampler2D",method:"1i",name:r,value:s}):"object"==typeof s&&i.push(...p(s,r))}return i}function R(){var e=document.getElementsByClassName("glslCanvas");if(e.length>0){window.glslCanvases=[];for(var t=0;t<e.length;t++){var i=new G(e[t]);i.isValid&&window.glslCanvases.push(i)}}}var v,_="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},b=v="undefined"!=typeof window?window:void 0!==_?_:"undefined"!=typeof self?self:{},A=function(e){var t=x.call(e);return"[object Function]"===t||"function"==typeof e&&"[object RegExp]"!==t||"undefined"!=typeof window&&(e===window.setTimeout||e===window.alert||e===window.confirm||e===window.prompt)},x=Object.prototype.toString,U=function(e,t){return t={exports:{}},e(t,t.exports),t.exports}(function(e,t){(t=e.exports=function(e){return e.replace(/^\s*|\s*$/g,"")}).left=function(e){return e.replace(/^\s*/,"")},t.right=function(e){return e.replace(/\s*$/,"")}}),y=function(r,n,s){if(!A(n))throw new TypeError("iterator must be a function");arguments.length<3&&(s=this),"[object Array]"===w.call(r)?e(r,n,s):"string"==typeof r?t(r,n,s):i(r,n,s)},w=Object.prototype.toString,L=Object.prototype.hasOwnProperty,X=function(e){return"[object Array]"===Object.prototype.toString.call(e)},S=function(e){if(!e)return{};var t={};return y(U(e).split("\n"),function(e){var i=e.indexOf(":"),r=U(e.slice(0,i)).toLowerCase(),n=U(e.slice(i+1));void 0===t[r]?t[r]=n:X(t[r])?t[r].push(n):t[r]=[t[r],n]}),t},P=function(){for(var e={},t=0;t<arguments.length;t++){var i=arguments[t];for(var r in i)D.call(i,r)&&(e[r]=i[r])}return e},D=Object.prototype.hasOwnProperty,F=s;s.XMLHttpRequest=b.XMLHttpRequest||function(){},s.XDomainRequest="withCredentials"in new s.XMLHttpRequest?s.XMLHttpRequest:b.XDomainRequest,function(e,t){for(var i=0;i<e.length;i++)t(e[i])}(["get","put","post","patch","head","delete"],function(e){s["delete"===e?"del":e]=function(t,i,r){return i=n(t,i,r),i.method=e.toUpperCase(),a(i)}});class M{constructor(e,t,i={}){d(this),this.gl=e,this.texture=e.createTexture(),this.texture&&(this.valid=!0),this.bind(),this.name=t,this.source=null,this.sourceType=null,this.loading=null,this.setData(1,1,new Uint8Array([0,0,0,255]),{filtering:"linear"}),this.setFiltering(i.filtering),this.load(i)}destroy(){this.valid&&(this.gl.deleteTexture(this.texture),this.texture=null,delete this.data,this.data=null,this.valid=!1)}bind(e){this.valid&&("number"==typeof e&&M.activeUnit!==e&&(this.gl.activeTexture(this.gl.TEXTURE0+e),M.activeUnit=e),M.activeTexture!==this.texture&&(this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),M.activeTexture=this.texture))}load(e={}){this.loading=null,"string"==typeof e.url?void 0!==this.url&&e.url===this.url||this.setUrl(e.url,e):e.element?this.setElement(e.element,e):e.data&&e.width&&e.height&&this.setData(e.width,e.height,e.data,e)}setUrl(e,t={}){if(this.valid)return this.url=e,this.source=this.url,this.sourceType="url",this.loading=new Promise((i,r)=>{let n=e.split(".").pop().toLowerCase(),s="ogv"===n||"webm"===n||"mp4"===n,a=void 0;s?((a=document.createElement("video")).autoplay=!0,t.filtering="nearest"):a=new Image,a.onload=(()=>{try{this.setElement(a,t)}catch(e){console.log(`Texture '${this.name}': failed to load url: '${this.source}'`,e,t)}i(this)}),a.onerror=(e=>{console.log(`Texture '${this.name}': failed to load url: '${this.source}'`,e,t),i(this)}),u()&&"data:"===this.source.slice(0,5)||(a.crossOrigin="anonymous"),a.src=this.source,s&&this.setElement(a,t)}),this.loading}setData(e,t,i,r={}){return this.width=e,this.height=t,this.source=i,this.sourceType="data",this.update(r),this.setFiltering(r),this.loading=Promise.resolve(this),this.loading}setElement(e,t){let i=e;if("string"==typeof e&&(e=document.querySelector(e)),e instanceof HTMLCanvasElement||e instanceof HTMLImageElement||e instanceof HTMLVideoElement)this.source=e,this.sourceType="element",e instanceof HTMLVideoElement?(e.addEventListener("canplaythrough",()=>{this.intervalID=setInterval(()=>{this.update(t)},15)},!0),e.addEventListener("ended",()=>{e.currentTime=0,e.play()},!0)):this.update(t),this.setFiltering(t);else{let e=`the 'element' parameter (\`element: ${JSON.stringify(i)}\`) must be a CSS `;e+="selector string, or a <canvas>, <image> or <video> object",console.log(`Texture '${this.name}': ${e}`,t)}return this.loading=Promise.resolve(this),this.loading}update(e={}){this.valid&&(this.bind(),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!1!==e.UNPACK_FLIP_Y_WEBGL),this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e.UNPACK_PREMULTIPLY_ALPHA_WEBGL||!1),"element"===this.sourceType&&(this.source instanceof HTMLCanvasElement||this.source instanceof HTMLVideoElement||this.source instanceof HTMLImageElement&&this.source.complete)?(this.source instanceof HTMLVideoElement?(this.width=this.source.videoWidth,this.height=this.source.videoHeight):(this.width=this.source.width,this.height=this.source.height),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.source)):"data"===this.sourceType&&this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.width,this.height,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.source),this.trigger("loaded",this))}setFiltering(e={}){if(!this.valid)return;this.powerOf2=l(this.width)&&l(this.height);let t=this.powerOf2?"mipmap":"linear";this.filtering=e.filtering||t;var i=this.gl;this.bind(),this.powerOf2?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,e.TEXTURE_WRAP_S||e.repeat&&i.REPEAT||i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,e.TEXTURE_WRAP_T||e.repeat&&i.REPEAT||i.CLAMP_TO_EDGE),"mipmap"===this.filtering?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR_MIPMAP_LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.generateMipmap(i.TEXTURE_2D)):"linear"===this.filtering?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR)):"nearest"===this.filtering&&(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST))):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),"mipmap"===this.filtering&&(this.filtering="linear"),"nearest"===this.filtering?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR)))}}M.getMaxTextureSize=function(e){return e.getParameter(e.MAX_TEXTURE_SIZE)},M.activeUnit=-1;let C="",I='\n\tThis page requires a browser that supports WebGL.<br/>\n\t<a href="http://get.webgl.org">Click here to upgrade your browser.</a>\n',N='\n\tIt does not appear your computer can support WebGL.<br/>\n\t<a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>\n';const O=1,B=2;class G{constructor(e,t,i){function r(){h.nMouse>1&&h.setMouse(o),h.forceRender=h.resize(),h.render(),window.requestAnimationFrame(r)}d(this),t=t||{},i=i||{},this.width=e.clientWidth,this.height=e.clientHeight,this.canvas=e,this.gl=void 0,this.program=void 0,this.textures={},this.buffers={},this.uniforms={},this.vbo={},this.isValid=!1,this.BUFFER_COUNT=0,this.TEXTURE_COUNT=0,this.vertexString=t.vertexString||"\n#ifdef GL_ES\nprecision mediump float;\n#endif\n\nattribute vec2 a_position;\nattribute vec2 a_texcoord;\n\nvarying vec2 v_texcoord;\n\nvoid main() {\n    gl_Position = vec4(a_position, 0.0, 1.0);\n    v_texcoord = a_texcoord;\n}\n",this.fragmentString=t.fragmentString||"\n#ifdef GL_ES\nprecision mediump float;\n#endif\n\nvarying vec2 v_texcoord;\n\nvoid main(){\n    gl_FragColor = vec4(0.0);\n}\n";let n=c(e,t,i.onError);if(!n)return;if(this.gl=n,this.timeLoad=this.timePrev=performance.now(),this.timeDelta=0,this.forceRender=!0,this.paused=!1,e.style.backgroundColor=t.backgroundColor||"rgba(1,1,1,0)",e.hasAttribute("data-fragment"))this.fragmentString=e.getAttribute("data-fragment");else if(e.hasAttribute("data-fragment-url")){let t=e.getAttribute("data-fragment-url");F.get(t,(e,t,i)=>{this.load(i,this.vertexString)})}if(e.hasAttribute("data-vertex"))this.vertexString=e.getAttribute("data-vertex");else if(e.hasAttribute("data-vertex-url")){let t=e.getAttribute("data-vertex-url");F.get(t,(e,t,i)=>{this.load(this.fragmentString,i)})}if(this.load(),!this.program)return;let s=n.getAttribLocation(this.program,"a_texcoord");this.vbo.texCoords=n.createBuffer(),this.gl.bindBuffer(n.ARRAY_BUFFER,this.vbo.texCoords),this.gl.bufferData(n.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),n.STATIC_DRAW),this.gl.enableVertexAttribArray(s),this.gl.vertexAttribPointer(s,2,n.FLOAT,!1,0,0);let a=n.getAttribLocation(this.program,"a_position");if(this.vbo.vertices=n.createBuffer(),this.gl.bindBuffer(n.ARRAY_BUFFER,this.vbo.vertices),this.gl.bufferData(n.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),n.STATIC_DRAW),this.gl.enableVertexAttribArray(a),this.gl.vertexAttribPointer(a,2,n.FLOAT,!1,0,0),e.hasAttribute("data-textures")){let t=e.getAttribute("data-textures").split(",");for(let e in t)this.setUniform("u_tex"+e,t[e])}let o={x:0,y:0};document.addEventListener("mousemove",e=>{o.x=e.clientX||e.pageX,o.y=e.clientY||e.pageY},!1);let h=this;return this.setMouse({x:0,y:0}),r(),this}destroy(){this.animated=!1,this.isValid=!1;for(let e in this.textures)e.destroy&&e.destroy();this.textures={};for(let e in this.attribs)this.gl.deleteBuffer(this.attribs[e]);this.gl.useProgram(null),this.gl.deleteProgram(this.program);for(let e in this.buffers){const t=this.buffers[e];this.gl.deleteProgram(t.program)}this.program=null,this.gl=null}load(e,t){if(t&&(this.vertexString=t),e&&(this.fragmentString=e),this.animated=!1,this.nDelta=(this.fragmentString.match(/u_delta/g)||[]).length,this.nTime=(this.fragmentString.match(/u_time/g)||[]).length,this.nDate=(this.fragmentString.match(/u_date/g)||[]).length,this.nMouse=(this.fragmentString.match(/u_mouse/g)||[]).length,this.animated=this.nDate>1||this.nTime>1||this.nMouse>1,this.fragmentString.search(/sampler2D/g)){let e=this.fragmentString.split("\n");for(let t=0;t<e.length;t++){let i=e[t].match(/uniform\s*sampler2D\s*([\w]*);\s*\/\/\s*([\w|\:\/\/|\.|\-|\_]*)/i);if(i){let e=i[2].split(".").pop().toLowerCase();i[1]&&i[2]&&("jpg"===e||"jpeg"===e||"png"===e||"ogv"===e||"webm"===e||"mp4"===e)&&this.setUniform(i[1],i[2])}if(e[t].match(/\s*void\s*main\s*/g))break}}let i=E(this,this.vertexString,this.gl.VERTEX_SHADER),r=E(this,this.fragmentString,this.gl.FRAGMENT_SHADER);r?this.isValid=!0:(r=E(this,"void main(){\n\tgl_FragColor = vec4(1.0);\n}",this.gl.FRAGMENT_SHADER),this.isValid=!1);let n=T(this,[i,r]);this.gl.useProgram(n),this.gl.deleteShader(i),this.gl.deleteShader(r),this.program=n,this.change=!0,this.BUFFER_COUNT=0;const s=this.getBuffers(this.fragmentString);Object.keys(s).length&&this.loadPrograms(s),this.buffers=s,this.trigger("load",{}),this.forceRender=!0}test(e,t,i){function r(){f.paused=o,(t||i)&&f.load(a,s)}function n(){f.forceRender=!0,f.render();let s=h.getQueryObjectEXT(l,h.QUERY_RESULT_AVAILABLE_EXT),a=f.gl.getParameter(h.GPU_DISJOINT_EXT);if(s&&!a){let n={wasValid:u,frag:t||f.fragmentString,vert:i||f.vertexString,timeElapsedMs:h.getQueryObjectEXT(l,h.QUERY_RESULT_EXT)/1e6};r(),e(n)}else window.requestAnimationFrame(n)}let s=this.vertexString,a=this.fragmentString,o=this.paused,h=this.gl.getExtension("EXT_disjoint_timer_query"),l=h.createQueryEXT(),u=this.isValid;(t||i)&&(this.load(t,i),u=this.isValid,this.forceRender=!0,this.render()),this.paused=!0,h.beginQueryEXT(h.TIME_ELAPSED_EXT,l),this.forceRender=!0,this.render(),h.endQueryEXT(h.TIME_ELAPSED_EXT);let f=this;n()}loadTexture(e,t,i){i||(i={}),"string"==typeof t?i.url=t:"object"==typeof t&&t.data&&t.width&&t.height?(i.data=t.data,i.width=t.width,i.height=t.height):"object"==typeof t&&(i.element=t),this.textures[e]?this.textures[e]&&(this.textures[e].load(i),this.textures[e].on("loaded",e=>{this.forceRender=!0})):(this.textures[e]=new M(this.gl,e,i),this.textures[e].on("loaded",e=>{this.forceRender=!0}))}refreshUniforms(){this.uniforms={}}setUniform(e,...t){let i={};i[e]=t,this.setUniforms(i)}setUniforms(e){let t=p(e);for(let e in t)"sampler2D"===t[e].type?this.loadTexture(t[e].name,t[e].value[0]):(this.uniform(t[e].method,t[e].type,t[e].name,t[e].value),this.forceRender=!0)}setMouse(e){let t=this.canvas.getBoundingClientRect();if(e&&e.x&&e.x>=t.left&&e.x<=t.right&&e.y&&e.y>=t.top&&e.y<=t.bottom){for(let i in this.buffers){const r=this.buffers[i];this.gl.useProgram(r.program),this.gl.uniform2f(this.gl.getUniformLocation(r.program,"u_mouse"),e.x-t.left,this.canvas.height-(e.y-t.top))}this.gl.useProgram(this.program),this.gl.uniform2f(this.gl.getUniformLocation(this.program,"u_mouse"),e.x-t.left,this.canvas.height-(e.y-t.top))}}uniform(e,t,i,...r){this.uniforms[i]=this.uniforms[i]||{};let n=this.uniforms[i];(f(n.value,r)||this.change||void 0===n.location||void 0===n.value)&&(n.name=i,n.value=r,n.type=t,n.method="uniform"+e,n.location=this.gl.getUniformLocation(this.program,i),this.gl[n.method].apply(this.gl,[n.location].concat(n.value)))}uniformTexture(e,t,i){if(void 0!==this.textures[e])return!0;this.loadTexture(e,t,i)}resize(){if(this.width!==this.canvas.clientWidth||this.height!==this.canvas.clientHeight){let e=window.devicePixelRatio||1,t=Math.floor(this.gl.canvas.clientWidth*e),i=Math.floor(this.gl.canvas.clientHeight*e);return this.gl.canvas.width===t&&this.gl.canvas.height===i||(this.gl.canvas.width=t,this.gl.canvas.height=i,this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height)),this.width=this.canvas.clientWidth,this.height=this.canvas.clientHeight,this.resizeSwappableBuffers(),!0}return!1}render(){this.visible=h(this.canvas),(this.forceRender||this.animated&&this.visible&&!this.paused)&&(this.renderPrograms(),this.trigger("render",{}),this.change=!1,this.forceRender=!1)}pause(){this.paused=!0}play(){this.paused=!1}version(){return"0.0.27"}renderPrograms(){const e=this.gl,t=e.canvas.width,i=e.canvas.height;this.updateVariables(),e.viewport(0,0,t,i);for(let r in this.buffers){const n=this.buffers[r];this.updateUniforms(n.program,r),n.bundle.render(t,i,n.program,n.name),e.bindFramebuffer(e.FRAMEBUFFER,null)}this.updateUniforms(this.program,"main"),e.drawArrays(e.TRIANGLES,0,6)}updateVariables(){const e=this;var t=new Date,i=performance.now();const r=this.variables||{};r.prev=r.prev||i,r.delta=(i-r.prev)/1e3,r.prev=i,r.load=e.timeLoad,r.time=(i-e.timeLoad)/1e3,r.year=t.getFullYear(),r.month=t.getMonth(),r.date=t.getDate(),r.daytime=3600*t.getHours()+60*t.getMinutes()+t.getSeconds()+.001*t.getMilliseconds(),this.variables=r}updateUniforms(e,t){const i=this.gl,r=this.variables;i.useProgram(e),this.nDelta>1&&i.uniform1f(i.getUniformLocation(e,"u_delta"),r.delta),this.nTime>1&&i.uniform1f(i.getUniformLocation(e,"u_time"),r.time),this.nDate&&i.uniform4f(i.getUniformLocation(e,"u_date"),r.year,r.month,r.date,r.daytime),i.uniform2f(i.getUniformLocation(e,"u_resolution"),this.canvas.width,this.canvas.height);for(let t in this.buffers){const r=this.buffers[t];i.uniform1i(i.getUniformLocation(e,r.name),r.bundle.input.index)}this.TEXTURE_COUNT=this.BUFFER_COUNT;for(let t in this.textures)if(this.uniformTexture(t,null,{filtering:"mipmap",repeat:!0})){const r=this.textures[t];i.activeTexture(i.TEXTURE0+this.TEXTURE_COUNT),i.bindTexture(i.TEXTURE_2D,r.texture),i.uniform1i(i.getUniformLocation(e,t),this.TEXTURE_COUNT),i.uniform2f(i.getUniformLocation(e,t+"Resolution"),r.width,r.height),this.TEXTURE_COUNT++}}getBuffers(e){let t={};return e&&e.replace(new RegExp("(defined\\s*\\(\\s*BUFFER_)(\\d+)\\s*\\)","g"),function(i,r,n){t["u_buffer_"+n]={fragment:"#define BUFFER_"+n+"\n"+e}}),t}loadPrograms(e){const t=this,i=this.gl;let r=0;const n=E(t,t.vertexString,i.VERTEX_SHADER);for(let s in e){const a=e[s];let o=E(t,a.fragment,i.FRAGMENT_SHADER,1);o?t.isValid=!0:(o=E(t,"void main(){\n\tgl_FragColor = vec4(1.0);\n}",i.FRAGMENT_SHADER),t.isValid=!1);const h=T(t,[n,o]);a.name="u_buffer_"+r,a.program=h,a.bundle=t.createSwappableBuffer(t.canvas.width,t.canvas.height,h),i.deleteShader(o),r++}i.deleteShader(n)}createSwappableBuffer(e,t,i){var r=this.createBuffer(e,t,i),n=this.createBuffer(e,t,i);const s=this.gl;return{input:r,output:n,swap:function(){var e=r;r=n,n=e,this.input=r,this.output=n},render:function(e,t,i,r){s.useProgram(i),s.viewport(0,0,e,t),s.bindFramebuffer(s.FRAMEBUFFER,this.input.buffer),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this.output.texture,0),s.drawArrays(s.TRIANGLES,0,6),this.swap()},resize:function(e,t,i,r){s.useProgram(i),s.viewport(0,0,e,t),this.input.resize(e,t),this.output.resize(e,t)}}}createBuffer(e,t,i){const r=this.gl;let n=this.BUFFER_COUNT;this.BUFFER_COUNT+=2,r.getExtension("OES_texture_float");var s=r.createTexture();r.activeTexture(r.TEXTURE0+n),r.bindTexture(r.TEXTURE_2D,s),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,e,t,0,r.RGBA,r.FLOAT,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE);var a=r.createFramebuffer();return{index:n,texture:s,buffer:a,W:e,H:t,resize:function(e,t){r.bindFramebuffer(r.FRAMEBUFFER,a);var i=Math.min(e,this.W),o=Math.min(t,this.H),h=new Float32Array(i*o*4);r.readPixels(0,0,i,o,r.RGBA,r.FLOAT,h),r.bindFramebuffer(r.FRAMEBUFFER,null);var l=n+1,u=r.createTexture();r.activeTexture(r.TEXTURE0+l),r.bindTexture(r.TEXTURE_2D,u),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,e,t,0,r.RGBA,r.FLOAT,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texSubImage2D(r.TEXTURE_2D,0,0,0,i,o,r.RGBA,r.FLOAT,h);var f=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,null),r.deleteTexture(s),r.activeTexture(r.TEXTURE0+n),r.bindTexture(r.TEXTURE_2D,u),n=this.index=n,s=this.texture=u,a=this.buffer=f,this.W=e,this.H=t}}}resizeSwappableBuffers(){const e=this.gl,t=e.canvas.width,i=e.canvas.height;e.viewport(0,0,t,i);for(let e in this.buffers){const r=this.buffers[e];r.bundle.resize(t,i,r.program,r.name)}e.useProgram(this.program)}}return window.addEventListener("load",function(){R()}),G});
//# sourceMappingURL=GlslCanvas.min.js.map
