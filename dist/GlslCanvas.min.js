!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.GlslCanvas=t()}(this,function(){"use strict";function e(e,t,r){for(var i=0,n=e.length;i<n;i++)L.call(e,i)&&t.call(r,e[i],i,e)}function t(e,t,r){for(var i=0,n=e.length;i<n;i++)t.call(r,e.charAt(i),i,e)}function r(e,t,r){for(var i in e)L.call(e,i)&&t.call(r,e[i],i,e)}function i(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}function n(e,t,r){var i=e;return _(t)?(r=t,"string"==typeof e&&(i={uri:e})):i=X(t,{uri:e}),i.callback=r,i}function a(e,t,r){return t=n(e,t,r),s(t)}function s(e){function t(){var e=void 0;if(e=l.response?l.response:l.responseText||o(l),E)try{e=JSON.parse(e)}catch(e){}return e}function r(e){return clearTimeout(c),e instanceof Error||(e=new Error(""+(e||"Unknown XMLHttpRequest Error"))),e.statusCode=0,u(e,T)}function n(){if(!f){var r;clearTimeout(c),r=e.useXDR&&void 0===l.status?200:1223===l.status?204:l.status;var i=T,n=null;return 0!==r?(i={body:t(),statusCode:r,method:d,headers:{},url:g,rawRequest:l},l.getAllResponseHeaders&&(i.headers=P(l.getAllResponseHeaders()))):n=new Error("Internal XMLHttpRequest Error"),u(n,i,i.body)}}if(void 0===e.callback)throw new Error("callback argument missing");var s=!1,u=function(t,r,i){s||(s=!0,e.callback(t,r,i))},l=e.xhr||null;l||(l=e.cors||e.useXDR?new a.XDomainRequest:new a.XMLHttpRequest);var h,f,c,g=l.url=e.uri||e.url,d=l.method=e.method||"GET",v=e.body||e.data,m=l.headers=e.headers||{},p=!!e.sync,E=!1,T={body:void 0,headers:{},statusCode:0,method:d,url:g,rawRequest:l};if("json"in e&&!1!==e.json&&(E=!0,m.accept||m.Accept||(m.Accept="application/json"),"GET"!==d&&"HEAD"!==d&&(m["content-type"]||m["Content-Type"]||(m["Content-Type"]="application/json"),v=JSON.stringify(!0===e.json?v:e.json))),l.onreadystatechange=function(){4===l.readyState&&setTimeout(n,0)},l.onload=n,l.onerror=r,l.onprogress=function(){},l.onabort=function(){f=!0},l.ontimeout=r,l.open(d,g,!p,e.username,e.password),p||(l.withCredentials=!!e.withCredentials),!p&&e.timeout>0&&(c=setTimeout(function(){if(!f){f=!0,l.abort("timeout");var e=new Error("XMLHttpRequest timeout");e.code="ETIMEDOUT",r(e)}},e.timeout)),l.setRequestHeader)for(h in m)m.hasOwnProperty(h)&&l.setRequestHeader(h,m[h]);else if(e.headers&&!i(e.headers))throw new Error("Headers cannot be set on an XDomainRequest object");return"responseType"in e&&(l.responseType=e.responseType),"beforeSend"in e&&"function"==typeof e.beforeSend&&e.beforeSend(l),l.send(v||null),l}function o(e){if("document"===e.responseType)return e.responseXML;var t=e.responseXML&&"parsererror"===e.responseXML.documentElement.nodeName;return""!==e.responseType||t?null:e.responseXML}function u(e){return'\n<table style="background-color: #8CE; width: 100%; height: 100%;"><tr>\n<td align="center">\n<div style="display: table-cell; vertical-align: middle;">\n<div style="">'+e+"</div>\n</div>\n</td></tr></table>\n"}function l(e,t,r){function i(t){var r=e.parentNode;r&&(r.innerHTML=u(t))}function n(e,t){"function"==typeof r?r(e):i(t)}if(!window.WebGLRenderingContext)return n(G,N),null;var a=h(e,t);return a?a.getExtension("OES_standard_derivatives"):n(H,B),a}function h(e,t){for(var r=["webgl","experimental-webgl"],i=null,n=0;n<r.length;++n)try{i=e.getContext(r[n],t)}catch(e){if(i)break}return i}function f(e,t,r,i){var n=e.gl,a=n.createShader(r);return n.shaderSource(a,t),n.compileShader(a),n.getShaderParameter(a,n.COMPILE_STATUS)?a:(O=n.getShaderInfoLog(a),console.error("*** Error compiling shader "+a+":"+O),e.trigger("error",{shader:a,source:t,type:r,error:O,offset:i||0}),n.deleteShader(a),null)}function c(e,t,r,i){for(var n=e.gl,a=n.createProgram(),s=0;s<t.length;++s)n.attachShader(a,t[s]);if(r)for(var o=0;o<r.length;++o)n.bindAttribLocation(a,i?i[o]:o,r[o]);return n.linkProgram(a),n.getProgramParameter(a,n.LINK_STATUS)?a:(O=n.getProgramInfoLog(a),console.log("Error in program linking:"+O),n.deleteProgram(a),null)}function g(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=[];for(var i in e){var n=e[i],a=void 0;if(t&&(i=t+"."+i),"number"==typeof n)r.push({type:"float",method:"1f",name:i,value:n});else if(Array.isArray(n)){if("number"==typeof n[0])1===n.length?r.push({type:"float",method:"1f",name:i,value:n}):n.length>=2&&n.length<=4?r.push({type:"vec"+n.length,method:n.length+"fv",name:i,value:n}):n.length>4&&r.push({type:"float[]",method:"1fv",name:i+"[0]",value:n});else if("string"==typeof n[0])r.push({type:"sampler2D",method:"1i",name:i,value:n});else if(Array.isArray(n[0])&&"number"==typeof n[0][0]){if(n[0].length>=2&&n[0].length<=4)for(a=0;a<n.length;a++)r.push({type:"vec"+n[0].length,method:n[a].length+"fv",name:i+"["+a+"]",value:n[a]})}else if("object"===M(n[0]))for(a=0;a<n.length;a++)r.push.apply(r,C(g(n[a],i+"["+a+"]")))}else"boolean"==typeof n?r.push({type:"bool",method:"1i",name:i,value:n}):"string"==typeof n?r.push({type:"sampler2D",method:"1i",name:i,value:n}):"object"===(void 0===n?"undefined":M(n))&&r.push.apply(r,C(g(n,i)))}return r}function d(e){return e.getBoundingClientRect().top+e.height>0&&e.getBoundingClientRect().top<(window.innerHeight||document.documentElement.clientHeight)}function v(e){return 0==(e&e-1)}function m(){return/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}function p(e,t){return!(!e||!t)&&e.toString()!==t.toString()}function E(e){var t=new Set;return Object.assign(e,{on:function(e,r){var i={};i[e]=r,t.add(i)},off:function(e,r){if(r){var i={};i[e]=r,t.delete(i)}else{var n=!0,a=!1,s=void 0;try{for(var o,u=t[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var l=o.value,h=!0,f=!1,c=void 0;try{for(var g,d=Object.keys(l)[Symbol.iterator]();!(h=(g=d.next()).done);h=!0)if(g.value===e)return void t.delete(l)}catch(e){f=!0,c=e}finally{try{!h&&d.return&&d.return()}finally{if(f)throw c}}}}catch(e){a=!0,s=e}finally{try{!n&&u.return&&u.return()}finally{if(a)throw s}}}},listSubscriptions:function(){var e=!0,r=!1,i=void 0;try{for(var n,a=t[Symbol.iterator]();!(e=(n=a.next()).done);e=!0){var s=n.value;console.log(s)}}catch(e){r=!0,i=e}finally{try{!e&&a.return&&a.return()}finally{if(r)throw i}}},subscribe:function(e){t.add(e)},unsubscribe:function(e){t.delete(e)},unsubscribeAll:function(){t.clear()},trigger:function(e){for(var r=arguments.length,i=Array(r>1?r-1:0),n=1;n<r;n++)i[n-1]=arguments[n];var a=!0,s=!1,o=void 0;try{for(var u,l=t[Symbol.iterator]();!(a=(u=l.next()).done);a=!0){var h=u.value;"function"==typeof h[e]&&h[e].apply(h,C(i))}}catch(e){s=!0,o=e}finally{try{!a&&l.return&&l.return()}finally{if(s)throw o}}}})}function T(){var e=document.getElementsByClassName("glslCanvas");if(e.length>0){window.glslCanvases=[];for(var t=0;t<e.length;t++){var r=new W(e[t]);r.isValid&&window.glslCanvases.push(r)}}}var y,b="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},R=y="undefined"!=typeof window?window:void 0!==b?b:"undefined"!=typeof self?self:{},_=function(e){var t=x.call(e);return"[object Function]"===t||"function"==typeof e&&"[object RegExp]"!==t||"undefined"!=typeof window&&(e===window.setTimeout||e===window.alert||e===window.confirm||e===window.prompt)},x=Object.prototype.toString,A=function(e,t){return t={exports:{}},e(t,t.exports),t.exports}(function(e,t){(t=e.exports=function(e){return e.replace(/^\s*|\s*$/g,"")}).left=function(e){return e.replace(/^\s*/,"")},t.right=function(e){return e.replace(/\s*$/,"")}}),w=function(i,n,a){if(!_(n))throw new TypeError("iterator must be a function");arguments.length<3&&(a=this),"[object Array]"===U.call(i)?e(i,n,a):"string"==typeof i?t(i,n,a):r(i,n,a)},U=Object.prototype.toString,L=Object.prototype.hasOwnProperty,S=function(e){return"[object Array]"===Object.prototype.toString.call(e)},P=function(e){if(!e)return{};var t={};return w(A(e).split("\n"),function(e){var r=e.indexOf(":"),i=A(e.slice(0,r)).toLowerCase(),n=A(e.slice(r+1));void 0===t[i]?t[i]=n:S(t[i])?t[i].push(n):t[i]=[t[i],n]}),t},X=function(){for(var e={},t=0;t<arguments.length;t++){var r=arguments[t];for(var i in r)D.call(r,i)&&(e[i]=r[i])}return e},D=Object.prototype.hasOwnProperty,F=a;a.XMLHttpRequest=R.XMLHttpRequest||function(){},a.XDomainRequest="withCredentials"in new a.XMLHttpRequest?a.XMLHttpRequest:R.XDomainRequest,function(e,t){for(var r=0;r<e.length;r++)t(e[r])}(["get","put","post","patch","head","delete"],function(e){a["delete"===e?"del":e]=function(t,r,i){return r=n(t,r,i),r.method=e.toUpperCase(),s(r)}});var M="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},I=(function(){function e(e){this.value=e}function t(t){function r(n,a){try{var s=t[n](a),o=s.value;o instanceof e?Promise.resolve(o.value).then(function(e){r("next",e)},function(e){r("throw",e)}):i(s.done?"return":"normal",s.value)}catch(e){i("throw",e)}}function i(e,t){switch(e){case"return":n.resolve({value:t,done:!0});break;case"throw":n.reject(t);break;default:n.resolve({value:t,done:!1})}(n=n.next)?r(n.key,n.arg):a=null}var n,a;this._invoke=function(e,t){return new Promise(function(i,s){var o={key:e,arg:t,resolve:i,reject:s,next:null};a?a=a.next=o:(n=a=o,r(e,t))})},"function"!=typeof t.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)}}(),function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}),k=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),C=function(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)},O="",N='\n\tThis page requires a browser that supports WebGL.<br/>\n\t<a href="http://get.webgl.org">Click here to upgrade your browser.</a>\n',B='\n\tIt does not appear your computer can support WebGL.<br/>\n\t<a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>\n',G=1,H=2,j=function(){function e(t,r){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};I(this,e),E(this),this.gl=t,this.texture=t.createTexture(),this.texture&&(this.valid=!0),this.bind(),this.name=r,this.source=null,this.sourceType=null,this.loading=null,this.setData(1,1,new Uint8Array([0,0,0,255]),{filtering:"linear"}),this.setFiltering(i.filtering),this.load(i)}return k(e,[{key:"destroy",value:function(){this.valid&&(this.gl.deleteTexture(this.texture),this.texture=null,delete this.data,this.data=null,this.valid=!1)}},{key:"bind",value:function(t){this.valid&&("number"==typeof t&&e.activeUnit!==t&&(this.gl.activeTexture(this.gl.TEXTURE0+t),e.activeUnit=t),e.activeTexture!==this.texture&&(this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),e.activeTexture=this.texture))}},{key:"load",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.loading=null,"string"==typeof e.url?void 0!==this.url&&e.url===this.url||this.setUrl(e.url,e):e.element?this.setElement(e.element,e):e.data&&e.width&&e.height&&this.setData(e.width,e.height,e.data,e)}},{key:"setUrl",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.valid)return this.url=e,this.source=this.url,this.sourceType="url",this.loading=new Promise(function(i,n){var a=e.split(".").pop().toLowerCase(),s="ogv"===a||"webm"===a||"mp4"===a,o=void 0;s?((o=document.createElement("video")).autoplay=!0,r.filtering="nearest"):o=new Image,o.onload=function(){try{t.setElement(o,r)}catch(e){console.log("Texture '"+t.name+"': failed to load url: '"+t.source+"'",e,r)}i(t)},o.onerror=function(e){console.log("Texture '"+t.name+"': failed to load url: '"+t.source+"'",e,r),i(t)},m()&&"data:"===t.source.slice(0,5)||(o.crossOrigin="anonymous"),o.src=t.source,s&&t.setElement(o,r)}),this.loading}},{key:"setData",value:function(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this.width=e,this.height=t,this.source=r,this.sourceType="data",this.update(i),this.setFiltering(i),this.loading=Promise.resolve(this),this.loading}},{key:"setElement",value:function(e,t){var r=this,i=e;if("string"==typeof e&&(e=document.querySelector(e)),e instanceof HTMLCanvasElement||e instanceof HTMLImageElement||e instanceof HTMLVideoElement)this.source=e,this.sourceType="element",e instanceof HTMLVideoElement?(e.addEventListener("canplaythrough",function(){r.intervalID=setInterval(function(){r.update(t)},15)},!0),e.addEventListener("ended",function(){e.currentTime=0,e.play()},!0)):this.update(t),this.setFiltering(t);else{var n="the 'element' parameter (`element: "+JSON.stringify(i)+"`) must be a CSS ";n+="selector string, or a <canvas>, <image> or <video> object",console.log("Texture '"+this.name+"': "+n,t)}return this.loading=Promise.resolve(this),this.loading}},{key:"update",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.valid&&(this.bind(),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!1!==e.UNPACK_FLIP_Y_WEBGL),this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e.UNPACK_PREMULTIPLY_ALPHA_WEBGL||!1),"element"===this.sourceType&&(this.source instanceof HTMLCanvasElement||this.source instanceof HTMLVideoElement||this.source instanceof HTMLImageElement&&this.source.complete)?(this.source instanceof HTMLVideoElement?(this.width=this.source.videoWidth,this.height=this.source.videoHeight):(this.width=this.source.width,this.height=this.source.height),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.source)):"data"===this.sourceType&&this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.width,this.height,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.source),this.trigger("loaded",this))}},{key:"setFiltering",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.valid){this.powerOf2=v(this.width)&&v(this.height);var t=this.powerOf2?"mipmap":"linear";this.filtering=e.filtering||t;var r=this.gl;this.bind(),this.powerOf2?(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,e.TEXTURE_WRAP_S||e.repeat&&r.REPEAT||r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,e.TEXTURE_WRAP_T||e.repeat&&r.REPEAT||r.CLAMP_TO_EDGE),"mipmap"===this.filtering?(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR_MIPMAP_LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.generateMipmap(r.TEXTURE_2D)):"linear"===this.filtering?(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR)):"nearest"===this.filtering&&(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST))):(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),"mipmap"===this.filtering&&(this.filtering="linear"),"nearest"===this.filtering?(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST)):(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR)))}}}]),e}();j.getMaxTextureSize=function(e){return e.getParameter(e.MAX_TEXTURE_SIZE)},j.activeUnit=-1;var W=function(){function e(t,r,i){function n(){v.nMouse>1&&v.setMouse(d),v.forceRender=v.resize(),v.render(),window.requestAnimationFrame(n)}var a=this;I(this,e),E(this),r=r||{},i=i||{},this.width=t.clientWidth,this.height=t.clientHeight,this.canvas=t,this.gl=void 0,this.program=void 0,this.textures={},this.uniforms={},this.vbo={},this.isValid=!1,this.TEXTURE_COUNT=0,this.BUFFER_COUNT=0,this.vertexString=r.vertexString||"\n#ifdef GL_ES\nprecision mediump float;\n#endif\n\nattribute vec2 a_position;\nattribute vec2 a_texcoord;\n\nvarying vec2 v_texcoord;\n\nvoid main() {\n    gl_Position = vec4(a_position, 0.0, 1.0);\n    v_texcoord = a_texcoord;\n}\n",this.fragmentString=r.fragmentString||"\n#ifdef GL_ES\nprecision mediump float;\n#endif\n\nvarying vec2 v_texcoord;\n\nvoid main(){\n    gl_FragColor = vec4(0.0);\n}\n";var s=l(t,r,i.onError);if(s){if(this.gl=s,this.timeLoad=this.timePrev=performance.now(),this.timeDelta=0,this.forceRender=!0,this.paused=!1,t.style.backgroundColor=r.backgroundColor||"rgba(1,1,1,0)",t.hasAttribute("data-fragment"))this.fragmentString=t.getAttribute("data-fragment");else if(t.hasAttribute("data-fragment-url")){var o=t.getAttribute("data-fragment-url");F.get(o,function(e,t,r){a.load(r,a.vertexString)})}if(t.hasAttribute("data-vertex"))this.vertexString=t.getAttribute("data-vertex");else if(t.hasAttribute("data-vertex-url")){var u=t.getAttribute("data-vertex-url");F.get(u,function(e,t,r){a.load(a.fragmentString,r)})}if(this.load(),this.program){var h=s.getAttribLocation(this.program,"a_texcoord");this.vbo.texCoords=s.createBuffer(),this.gl.bindBuffer(s.ARRAY_BUFFER,this.vbo.texCoords),this.gl.bufferData(s.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),s.STATIC_DRAW),this.gl.enableVertexAttribArray(h),this.gl.vertexAttribPointer(h,2,s.FLOAT,!1,0,0);var f=s.getAttribLocation(this.program,"a_position");if(this.vbo.vertices=s.createBuffer(),this.gl.bindBuffer(s.ARRAY_BUFFER,this.vbo.vertices),this.gl.bufferData(s.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),s.STATIC_DRAW),this.gl.enableVertexAttribArray(f),this.gl.vertexAttribPointer(f,2,s.FLOAT,!1,0,0),t.hasAttribute("data-textures")){var c=t.getAttribute("data-textures").split(",");for(var g in c)this.setUniform("u_tex"+g,c[g])}var d={x:0,y:0};document.addEventListener("mousemove",function(e){d.x=e.clientX||e.pageX,d.y=e.clientY||e.pageY},!1);var v=this;return this.setMouse({x:0,y:0}),n(),this}}}return k(e,[{key:"destroy",value:function(){this.animated=!1,this.isValid=!1;for(var e in this.textures)e.destroy&&e.destroy();this.textures={};for(var t in this.attribs)this.gl.deleteBuffer(this.attribs[t]);if(this.gl.useProgram(null),this.gl.deleteProgram(this.program),this.buffers&&Object.keys(this.buffers).length>0)for(var r in this.buffers){var i=this.buffers[r];this.gl.deleteProgram(i.program)}this.program=null,this.gl=null}},{key:"load",value:function(e,t){t&&(this.vertexString=t),e&&(this.fragmentString=e);var r=this.parseString(this.fragmentString,this.vertexString);if(this.animated=!1,this.nDelta=(r.fragment.match(/u_delta/g)||[]).length,this.nTime=(r.fragment.match(/u_time/g)||[]).length,this.nDate=(r.fragment.match(/u_date/g)||[]).length,this.nMouse=(r.fragment.match(/u_mouse/g)||[]).length,this.animated=this.nDate>1||this.nTime>1||this.nMouse>1,r.fragment.search(/sampler2D/g))for(var i=r.fragment.split("\n"),n=0;n<i.length;n++){var a=i[n].match(/uniform\s*sampler2D\s*([\w]*);\s*\/\/\s*([\w|\:\/\/|\.|\-|\_]*)/i);if(a){var s=a[2].split(".").pop().toLowerCase();a[1]&&a[2]&&("jpg"===s||"jpeg"===s||"png"===s||"ogv"===s||"webm"===s||"mp4"===s)&&this.setUniform(a[1],a[2])}if(i[n].match(/\s*void\s*main\s*/g))break}var o=f(this,r.vertex,this.gl.VERTEX_SHADER),u=f(this,r.fragment,this.gl.FRAGMENT_SHADER,r.offset);u?this.isValid=!0:(u=f(this,"void main(){\n\tgl_FragColor = vec4(1.0);\n}",this.gl.FRAGMENT_SHADER),this.isValid=!1);var l=c(this,[o,u]);this.gl.useProgram(l),this.gl.deleteShader(o),this.gl.deleteShader(u),this.program=l,this.change=!0,Object.keys(r.buffers).length&&this.loadPrograms(r.buffers),this.trigger("load",{}),this.forceRender=!0}},{key:"test",value:function(e,t,r){function i(){f.paused=o,(t||r)&&f.load(s,a)}function n(){f.forceRender=!0,f.render();var a=u.getQueryObjectEXT(l,u.QUERY_RESULT_AVAILABLE_EXT),s=f.gl.getParameter(u.GPU_DISJOINT_EXT);if(a&&!s){var o={wasValid:h,frag:t||f.fragmentString,vert:r||f.vertexString,timeElapsedMs:u.getQueryObjectEXT(l,u.QUERY_RESULT_EXT)/1e6};i(),e(o)}else window.requestAnimationFrame(n)}var a=this.vertexString,s=this.fragmentString,o=this.paused,u=this.gl.getExtension("EXT_disjoint_timer_query"),l=u.createQueryEXT(),h=this.isValid;(t||r)&&(this.load(t,r),h=this.isValid,this.forceRender=!0,this.render()),this.paused=!0,u.beginQueryEXT(u.TIME_ELAPSED_EXT,l),this.forceRender=!0,this.render(),u.endQueryEXT(u.TIME_ELAPSED_EXT);var f=this;n()}},{key:"loadTexture",value:function(e,t,r){var i=this;r||(r={}),"string"==typeof t?r.url=t:"object"===(void 0===t?"undefined":M(t))&&t.data&&t.width&&t.height?(r.data=t.data,r.width=t.width,r.height=t.height):"object"===(void 0===t?"undefined":M(t))&&(r.element=t),this.textures[e]?this.textures[e]&&(this.textures[e].load(r),this.textures[e].on("loaded",function(e){i.forceRender=!0})):(this.textures[e]=new j(this.gl,e,r),this.textures[e].on("loaded",function(e){i.forceRender=!0}))}},{key:"refreshUniforms",value:function(){this.uniforms={}}},{key:"setUniform",value:function(e){for(var t={},r=arguments.length,i=Array(r>1?r-1:0),n=1;n<r;n++)i[n-1]=arguments[n];t[e]=i,this.setUniforms(t)}},{key:"setUniforms",value:function(e){var t=g(e);for(var r in t)"sampler2D"===t[r].type?this.loadTexture(t[r].name,t[r].value[0]):(this.uniform(t[r].method,t[r].type,t[r].name,t[r].value),this.forceRender=!0)}},{key:"setMouse",value:function(e){var t=this.canvas.getBoundingClientRect();if(e&&e.x&&e.x>=t.left&&e.x<=t.right&&e.y&&e.y>=t.top&&e.y<=t.bottom){if(this.buffers&&Object.keys(this.buffers).length>0)for(var r in this.buffers){var i=this.buffers[r];this.gl.useProgram(i.program),this.gl.uniform2f(this.gl.getUniformLocation(i.program,"u_mouse"),e.x-t.left,this.canvas.height-(e.y-t.top))}this.gl.useProgram(this.program),this.gl.uniform2f(this.gl.getUniformLocation(this.program,"u_mouse"),e.x-t.left,this.canvas.height-(e.y-t.top))}}},{key:"uniform",value:function(e,t,r){this.uniforms[r]=this.uniforms[r]||{};for(var i=this.uniforms[r],n=arguments.length,a=Array(n>3?n-3:0),s=3;s<n;s++)a[s-3]=arguments[s];(p(i.value,a)||this.change||void 0===i.location||void 0===i.value)&&(i.name=r,i.value=a,i.type=t,i.method="uniform"+e,i.location=this.gl.getUniformLocation(this.program,r),this.gl[i.method].apply(this.gl,[i.location].concat(i.value)))}},{key:"uniformTexture",value:function(e,t,r){void 0===this.textures[e]?this.loadTexture(e,t,r):(this.uniform("1i","sampler2D",e,this.texureIndex),this.textures[e].bind(this.texureIndex),this.uniform("2f","vec2",e+"Resolution",this.textures[e].width,this.textures[e].height),this.texureIndex++)}},{key:"resize",value:function(){if(this.width!==this.canvas.clientWidth||this.height!==this.canvas.clientHeight){var e=window.devicePixelRatio||1,t=Math.floor(this.gl.canvas.clientWidth*e),r=Math.floor(this.gl.canvas.clientHeight*e);return this.gl.canvas.width===t&&this.gl.canvas.height===r||(this.gl.canvas.width=t,this.gl.canvas.height=r,this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height)),this.width=this.canvas.clientWidth,this.height=this.canvas.clientHeight,this.resizeSwappableBuffers(),!0}return!1}},{key:"render",value:function(){this.visible=d(this.canvas),(this.forceRender||this.animated&&this.visible&&!this.paused)&&(this.renderPrograms(),this.trigger("render",{}),this.change=!1,this.forceRender=!1)}},{key:"pause",value:function(){this.paused=!0}},{key:"play",value:function(){this.paused=!1}},{key:"version",value:function(){return"0.0.27"}},{key:"renderPrograms",value:function(){var e=this.gl,t=e.canvas.width,r=e.canvas.height;if(this.updateVariables(),e.viewport(0,0,t,r),this.buffers&&Object.keys(this.buffers).length>0){for(var i in this.buffers){var n=this.buffers[i];this.updateUniforms(n.program,i),n.bundle.render(t,r,n.program,n.name)}e.bindFramebuffer(e.FRAMEBUFFER,null)}this.updateUniforms(this.program,"main"),e.drawArrays(e.TRIANGLES,0,6)}},{key:"updateVariables",value:function(){var e=this,t=new Date,r=performance.now(),i=this.variables||{};i.prev=i.prev||r,i.delta=(r-i.prev)/1e3,i.prev=r,i.load=e.timeLoad,i.time=(r-e.timeLoad)/1e3,i.year=t.getFullYear(),i.month=t.getMonth(),i.date=t.getDate(),i.daytime=3600*t.getHours()+60*t.getMinutes()+t.getSeconds()+.001*t.getMilliseconds(),this.variables=i}},{key:"updateUniforms",value:function(e,t){var r=this.gl,i=this.variables;r.useProgram(e),this.nDelta>1&&r.uniform1f(r.getUniformLocation(e,"u_delta"),i.delta),this.nTime>1&&r.uniform1f(r.getUniformLocation(e,"u_time"),i.time),this.nDate&&r.uniform4f(r.getUniformLocation(e,"u_date"),i.year,i.month,i.date,i.daytime),r.uniform2f(r.getUniformLocation(e,"u_resolution"),this.canvas.width,this.canvas.height),this.texureIndex=0;for(var n in this.textures)this.uniformTexture(n,{filtering:"mipmap",repeat:!0});for(var a in this.buffers){var s=this.buffers[a];r.uniform1i(r.getUniformLocation(e,s.name),s.bundle.input.index)}}},{key:"parseString",value:function(e,t){var r=e,i={vertex:t,fragment:null,main:null,buffers:{}},n=0;e&&(e=(e=e.replace(new RegExp("(/{2} u_buffer_)(\\d+).*((.|[\\r\\n]+)*?)(?=/{2} u_buffer|/{2} main|$)","g"),function(e,t,n,a,s,o){return o=r.substr(0,o).split("\n").length,i.buffers["u_buffer_"+n]={fragment:a,offset:o},""})).replace(new RegExp("(/{2} main).*((.|[\\r\\n]+)*)(?=/{2} u_buffer|$)","g"),function(e,t,r,n,a){return i.main=r,""}),n=e.split("\n").length),i.main&&r.replace(new RegExp("(/{2} main).*((.|[\\r\\n]+)*)(?=/{2} u_buffer|$)","g"),function(e,t,i,a,s){return s=r.substr(0,s).split("\n").length-n,""});for(var a in i.buffers)i.buffers[a].common=e,i.buffers[a].offset-=n;return i.fragment=e+(i.main||""),i.offset=0,i}},{key:"loadPrograms",value:function(e){var t=this,r=this.gl,i=0;this.buffers={};var n=f(t,t.vertexString,r.VERTEX_SHADER);for(var a in e){var s=e[a],o=f(t,s.common+s.fragment,r.FRAGMENT_SHADER,s.line);o?t.isValid=!0:(o=f(t,"void main(){\n\tgl_FragColor = vec4(1.0);\n}",r.FRAGMENT_SHADER),t.isValid=!1);var u=c(t,[n,o]);s.name="u_buffer_"+i,s.program=u,s.bundle=t.createSwappableBuffer(t.canvas.width,t.canvas.height,u),t.buffers[a]=s,r.deleteShader(o),i++}r.deleteShader(n)}},{key:"createSwappableBuffer",value:function(e,t,r){var i=this.createBuffer(e,t,r),n=this.createBuffer(e,t,r),a=this.gl;return{input:i,output:n,swap:function(){var e=i;i=n,n=e,this.input=i,this.output=n},render:function(e,t,r,i){a.useProgram(r),a.viewport(0,0,e,t),a.bindFramebuffer(a.FRAMEBUFFER,this.input.buffer),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.output.texture,0),a.drawArrays(a.TRIANGLES,0,6),this.swap()},resize:function(e,t,r,i){a.useProgram(r),a.viewport(0,0,e,t),this.input.resize(e,t),this.output.resize(e,t)}}}},{key:"createBuffer",value:function(e,t,r){var i=this,n=this.gl,a=this.TEXTURE_COUNT+this.BUFFER_COUNT;this.BUFFER_COUNT++,this.gl.getExtension("OES_texture_float");var s=this.gl.createTexture();this.gl.activeTexture(this.gl.TEXTURE0+a),this.gl.bindTexture(this.gl.TEXTURE_2D,s),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,e,t,0,this.gl.RGBA,this.gl.FLOAT,null),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE);var o=this.gl.createFramebuffer();return{index:a,texture:s,buffer:o,W:e,H:t,resize:function(e,t){n.bindFramebuffer(n.FRAMEBUFFER,o);var r=Math.min(e,this.W),u=Math.min(t,this.H),l=new Float32Array(r*u*4);n.readPixels(0,0,r,u,n.RGBA,n.FLOAT,l),n.bindFramebuffer(n.FRAMEBUFFER,null);var h=i.TEXTURE_COUNT+i.BUFFER_COUNT,f=n.createTexture();n.activeTexture(n.TEXTURE0+h),n.bindTexture(n.TEXTURE_2D,f),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,e,t,0,n.RGBA,n.FLOAT,null),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texSubImage2D(n.TEXTURE_2D,0,0,0,r,u,n.RGBA,n.FLOAT,l);var c=n.createFramebuffer();n.bindFramebuffer(n.FRAMEBUFFER,null),n.deleteTexture(s),n.activeTexture(n.TEXTURE0+a),n.bindTexture(n.TEXTURE_2D,f),a=this.index=a,s=this.texture=f,o=this.buffer=c,this.W=e,this.H=t}}}},{key:"resizeSwappableBuffers",value:function(){var e=this.gl;if(this.buffers&&Object.keys(this.buffers).length>0){var t=e.canvas.width,r=e.canvas.height;e.viewport(0,0,t,r);for(var i in this.buffers){var n=this.buffers[i];n.bundle.resize(t,r,n.program,n.name)}e.useProgram(this.program)}}}]),e}();return window.addEventListener("load",function(){T()}),W});
//# sourceMappingURL=GlslCanvas.min.js.map
